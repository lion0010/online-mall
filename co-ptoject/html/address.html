<!DOCTYPE html>
<html lang="en">

<head>
<<<<<<< HEAD
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>收获地址页</title>
  <link rel="stylesheet" href="../style/reset.css">
  <link rel="stylesheet" href="../style/main.css">
  <link rel="stylesheet" href="../style/address.css">
=======
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="../style/reset.css">
    <link rel="stylesheet" href="../style/main.css">
    <link rel="stylesheet" href="../style/address.css">
>>>>>>> b7d8adb12617d54b3d798ac01b985ade66afa631
</head>

<body>
    <script src="../js/myajax.js" charset="utf-8"></script>
    <script src="../js/address.js"></script>
    <header>
        <p>喵喵喵，欢迎小主</p>
        <ul>
            <li><a href="login.html" name="login" class="login">欢迎登录</a></li>
            <li><a href="register.html" name="register" class="register">免费注册</a></li>
            <li><a href="#" name="username" class="username">小主</a></li>
            <li><a href="javascript:localStorage.clear(); location.reload();" class="logout">退出</a></li>
            <script>
                //判断用户名如果存在, 则显示用户名并显示退出按钮, 否则显示注册和登录
                if (localStorage.username) {
                    var oUsername = document.querySelector('a[name=username]');
                    var oLogout = document.querySelector('.logout');
                    oUsername.innerText = localStorage.username;
                    oUsername.style.display = 'inline';
                    oLogout.style.display = 'inline';
                } else {
                    var oRegister = document.querySelector('.register');
                    var oLogin = document.querySelector('.login');
                    oRegister.style.display = 'inline';
                    oLogin.style.display = 'inline';
                }
            </script>
            <li><a href="cart.html">购物车</a></li>
            <li><a href="order.html">我的订单</a></li>
        </ul>
    </header>
    <div class="header-box">
        <div class="header-box-left">我的收货地址</div>
        <a class="header-box-right" href="../index.html">首页</a>
    </div>
    <div class="container">
        <div class="left-add">
            <form>
                <p>添加收货地址</p>
                <label>
          地址名称:
          <input type="text" name="address_name" placeholder="公司/家">
        </label>
                <label>
          收货人:
          <input type="text" name="consignee" placeholder="姓名">
        </label>
                <label>
          国家:
          <input type="text" name="country" placeholder="国籍">
        </label>
                <label>
          省:
          <input type="text" name="province" placeholder="省份">
        </label>
                <label>
          市:
          <input type="text" name="city" placeholder="城市">
        </label>
                <label>
          区:
          <input type="text" name="district" placeholder="片区">
        </label>
                <label>
          地址:
          <input type="text" name="address" placeholder="详细地址">
        </label>
                <label>
          邮编:
          <input type="text" name="zip_code" placeholder="邮政编码">
        </label>
                <label>
          手机号:
          <input type="text" name="mobile" placeholder="预留手机号码">
        </label>
                <label>
          邮箱:
          <input type="text" name="email" placeholder="QQ/其他类的邮箱">
        </label>
                <label>
          电话:
          <input type="text" name="tel" placeholder="常用电话">
        </label>
                <label>
          最佳送货时间:
          <input type="text" name="besttime" placeholder="周一到周五">
        </label>
                <label>
          标志物:
          <input type="text" name="sign_building" placeholder="易于看见的标志性物体">
        </label>
                <label>
          <input type="button" value="添加" class="add">
        </label>
            </form>
        </div>
        <div class="list-address">
            <span> 收货地址</span>
            <div class="address">
                <div>
                    <ul class="address-ul" id="add-address">
                        <li>
                            <span>收货人</span>
                            <span>手机号</span>
                            <span>详细地址</span>
                            <span>操作</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <script>
        var oAdd = document.querySelector('.add');
        console.log(oAdd);
        oAdd.onclick = function() {
            var postobj = serializeForm(document.querySelector('form'));
            myajax.post('http://h6.duchengjiu.top/shop/api_useraddress.php?status=add&token=' + localStorage.token, postobj, function(err, responseText) {
                var json = JSON.parse(responseText);
                console.log(json);
                if (json.code === 0) {
                    location.reload();
                    // showAddress();

                } else if (json.code === 1002) {
                    toast("未登录，3秒后将跳转到登陆页面")
                        // var oSecond = oGoods.querySelector('#second');
                    var timer = setInterval(() => {
                        // var second = parseInt(oSecond.innerText);
                        // oSecond.innerText = --second;
                        location.href = "../html/login.html"
                    }, 3000);

                }
            });
        }
    </script>

    <!-- <script src="../js/animate-2.0.1.js"></script>
<script>
var oShowAllAddress = document.querySelector('.show-all-address');
oShowAllAddress.addEventListener('click', function() {
  var oAddressUl = document.querySelector('.address-ul');
  var overflow = fetchComputedStyle(oAddressUl, 'overflow');
  var flag = overflow === 'hidden' ? false : true;
  oAddressUl.style.overflow = !flag ? 'visible' : 'hidden';
  this.innerText = flag ? '显示全部地址' : '隐藏地址';
});
</script> -->
    <script src="../js/showBo.js"></script>
    <script>
        //ajax读取到收货地址并显示
        function showAddress() {
            myajax.get('http://h6.duchengjiu.top/shop/api_useraddress.php', {
                    token: localStorage.token
                },
                function(error, responseText) {
                    var json = JSON.parse(responseText);
                    console.log(json);
                    var data = json.data;
                    var oAddressUl = document.querySelector('.address-ul');
                    if (data.length === 0) {
                        oAddressUl.innerHTML = '<h2>您还没有收货地址，请点击添加收货地址</h2>';
                        return;
                    }
                    // oAddressUl.innerHTML = '';
                    for (var i = data.length - 1; i >= 0; i--) {
                        var obj = data[i];
                        oAddressUl.innerHTML += `
                            <li data-id="${obj.address_id}">
                              <span>${obj.consignee}</span>
                              <span>${obj.mobile}</span>
                              <span>${obj.address}</span>
                              <span name="delete" class="delete" data-id="${obj.address_id}">删除</span>
                            </li>
            `;
                    }
                })
        }
        showAddress();
        // //给添加按钮添加事件
        // var oAdd = document.querySelector('.add');
        // oAdd.onclick = function() {
        //   var postobj = serializeForm(document.querySelector('form'));
        //   myajax.post('http://h6.duchengjiu.top/shop/api_useraddress.php?status=add&token= '+localStorage.token, postobj, function(err, responseText){
        //     var json = JSON.parse(responseText);
        //     console.log(json);
        //     if (json.code === 0) {
        //       showAddress();
        //     }
        //   });
        // }
        var selected_address_id = 0; //如果这个值为0，无法下订单，当点击一个收货地址时，给这个变量赋值
        //给收货地址添加一个事件代理
        var oAddressUl = document.querySelector('.address-ul');
        oAddressUl.onclick = function(event) {
            event = event || window.event;
            var target = event.target || event.srcElement;
            console.log(target.nodeName);
            if (target.className === 'delete') {
                if (!Showbo.Msg.confirm('您确定删除这条记录吗？')) {
                    return;
                }
                var address_id = target.dataset.id;
                console.log(address_id);
                myajax.get('http://h6.duchengjiu.top/shop/api_useraddress.php', {
                    status: 'delete',
                    address_id,
                    token: localStorage.token
                }, function(error, responseText) {
                    var json = JSON.parse(responseText);
                    if (json.code === 0) {
                        target.parentNode.parentNode.removeChild(target.parentNode);
                        location.reload();
                    }
                })
            } else {
                //先让所有li元素的样式清空
                var oAddressLis = oAddressUl.querySelectorAll('li');
                for (var i = 0; i < oAddressLis.length; i++) {
                    oAddressLis[i].classList.remove('selected');
                }

                if (target.nodeName === 'LI') {
                    //点击LI元素选择一个收货地址
                    selected_address_id = parseInt(target.dataset.id);
                    target.classList.add('selected');
                } else if (target.nodeName === 'SPAN') {
                    selected_address_id = parseInt(target.parentNode.dataset.id);
                    target.parentNode.classList.add('selected');
                }

            }
        }
    </script>
    <div id="order" class="take-order">
        <button>下订单</button>
    </div>
    <script>
        var oOrder = document.querySelector('#order');
        oOrder.onclick = function() {
            var address_id = selected_address_id;
            if (address_id === 0) {
                toast('请选择一个收货地址');
                return;
            }
            location.href = 'order.html';
            var total_prices = localStorage.sum;
            myajax.post('http://h6.duchengjiu.top/shop/api_order.php?token=' + localStorage.token + '&status=add', {
                address_id,
                total_prices
            }, function(err, responseText) {
                var json = JSON.parse(responseText);
                console.log(json);
                if (json.code === 0) {
                    toast('下订单成功');

                }
            });

        }
    </script>
    <!-- </main> -->
    <!-- <script>


    //给添加按钮添加事件
    var oAdd = document.querySelector('.add');
    oAdd.onclick = function() {
      var postobj = serializeForm(document.querySelector('form'));
      myajax.post('http://h6.duchengjiu.top/shop/api_useraddress.php?status=add&token='+localStorage.token, postobj, function(err, responseText){
        var json = JSON.parse(responseText);
        console.log(json);
        if (json.code === 0) {

          showAddress();
        }
      });
    }
  </script> -->
    <script src="../js/components.js"></script>
</body>

</html>